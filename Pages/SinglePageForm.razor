@using ITDocumentation.Data
@using System.Collections.Generic
@inject ApplicationDbContext dbContext
@inject ProtectedSessionStorage ProtectedSessionStore
@inject NavigationManager navigationManager
@inject NavigationManager NavigationManager;
@using System.Text.Json
@using System.Text.Json.Nodes


<RadzenTemplateForm Data="@singlePage" Submit="@((SinglePage args) => { Submit(args); })">

    <br>
     @{
         if (singlePage.Name == "Core Values")
           {
    <div class="row">
        <div class="col-sm-2 ">
            <RadzenLabel Text="*Page Name" />
        </div>
        <div class="col-sm-8">
           
                    <RadzenTextBox @bind-Value=@singlePage!.Name Name="Name" Disabled=@disablePageName style="width:100%;" />
                    <br>
                    <RadzenRequiredValidator Component="Name" Text="Page Name is required" Popup="true" Style="position: absolute" />            
        </div>
    </div>
        }

    }
    <br>
    @if(singlePage.Name == "Core Values"){

        <RadzenLabel Text="*Content" />
        <TextEditor singlePage="@singlePage"
                    type="@parent"
                    projectPage="null" />
        <br>
    }

    @{
        if (!disablePageName)
        {
            <UploadDocument pageID="@tmpPageID"
                            parent="singlePage"
                            ReloadDocumentsTable__parentEvent="@ReloadDocumentsTable"
                            ReloadPendingDocumentsTable__parentEvent="@ReloadPendingDocumentsTable"
                            pageState="@state"
                            tmpDocuments="@tmpDocuments"
                            tmpPendingDocuments="@tmpPendingDocuments"
                            documents="@documents"
                            SetUploadComponent__parentEvent="@SetUploadComponent"
                            SetUploadCompleted__parentEvent="@SetUploadCompleted"
                            SetPageId__parentEvent="@SetPageId"
                            SetPageState__parentEvent="@SetPageState"
                            documentsHandler="@documentsHandler"
                            state="@documentState"
                           documentID="@documentID" />
            <br>
            <br>
            <DocumentsTable pageID="@tmpPageID"
                            parent="@parent"
                            documents="@documents"
                            tmpDocuments="@tmpDocuments"
                            deleteDocumentDisabled="true"
                            reloadDocumentsTable__parentEvent="@ReloadDocumentsTable"
                            subdepartmentID="@subdepartmentID"
                            SetDocumentID__ParentEvent="@SetDocumentID"
                            SetDocumentState__ParentEvent="@SetDocumentState" />



        }

    }

    <br>
    <br>
    <div class="row justify-content-center">
        <div class="col-md-12 d-flex align-items-end justify-content-left" style="margin-top: 16px;">


            <RadzenButton ButtonType="ButtonType.Submit" Icon="save" Text="Save" />
            <RadzenButton Icon="cancel" style="display: inline-block; margin-left: 10px;" Text="Cancel" Click="@Cancel" />
        </div>
    </div>
</RadzenTemplateForm>



@code {

    [Parameter]
    public EventCallback<string> SetState__ParentEvent { get; set; }
    [Parameter]
    public EventCallback<SinglePage> SetSinglePage__parentEvent { get; set; }
    [Parameter]
    public int subdepartmentID { get; set; }
    [Parameter]
    public SinglePage singlePage { get; set; }
    [Parameter]
    public EventCallback ReloadPage__ParentEvent { get; set; }
    [Parameter]
    public string state { get; set; }
    List<string> tagList = new List<string>();
    JsonReader reader;
    string documentState = "";
    int documentID = 0;


    List<string> documentTags;
    List<string> tag;
    string addTag1;
    string addTag2;
    string addTag3;
    string addTag4;



    List<Document> documents;
    List<PendingDocument> pendingDocuments;
    List<Document> tmpDocuments;
    List<PendingDocument> tmpPendingDocuments;
    DocumentsHandler documentsHandler;
    string parent = "singlePage";
    int tmpPageID;
    string userName = "";
    bool disablePageName = false;
    bool showTaggingComponent = true;
    RadzenUpload uploadLocal;
    bool uploadCompleted = false;
    SinglePagesHelper singlePagesHelper;
    [Parameter]
    public EventCallback<bool> ShowAlert__ParentEvent { get; set; }
    [Parameter]
    public EventCallback<string> SetAlertMessage__ParentEvent { get; set; }
    [Parameter]
    public EventCallback<string> SetAlertType__ParentEvent { get; set; }



    protected override async Task OnInitializedAsync()
    {
        //documentTags = new List<string>();
        ResetTags();
        singlePagesHelper = new SinglePagesHelper(dbContext);
        documentsHandler = new DocumentsHandler(dbContext);
        tmpDocuments = new List<Document>();
        tmpPendingDocuments = new List<PendingDocument>();
        InitPageID();
        InitTagList();
        documents = documentsHandler!.initDocuments(documents, parent, tmpPageID);
        //pendingDocuments = documentsHandler!.initPendingDocuments(pendingDocuments, parent, tmpPageID);
        var result = await ProtectedSessionStore.GetAsync<string>("user");
        if (result.Success)
        {
            userName = result.Value!.ToUpper();
        }

        if (singlePage!.Name == "About")
        {
            disablePageName = true;
            showTaggingComponent = false;

        }


    }

    void SetPageId(int pageId)
    {
        SinglePage lastInserted = dbContext.SinglePage.First(s => s.ID == pageId);
        pageId = tmpPageID;
        SetSinglePage__parentEvent.InvokeAsync(lastInserted);

    }
    void SetPageState(string state)
    {
        SetState__ParentEvent.InvokeAsync(state);
    }

    void InitTagList()
    {
        tagList = new List<string>();
        reader = new JsonReader();
        JsonNode contentTags = reader.getTags("ContentTags.json");
        JsonObject jsonObj = contentTags.AsObject();
        JsonNode itemTags = contentTags[singlePage.ID.ToString()]!;

        if (jsonObj.ContainsKey(singlePage.ID.ToString()))
        {
            if (itemTags["Type"]!.ToString() == parent)
            {

                foreach (var tagName in contentTags[singlePage.ID.ToString()]["Tags"].AsArray())
                {

                    tagList.Add(tagName.ToString());
                }

            }


        }

    }


    void SetDocumentState(string documentState)
    {
        this.documentState = documentState;
    }

    void SetDocumentID(int documentID)
    {
        this.documentID = documentID;

    }

    void SetDocumentTags(List<string> documentTags)
    {
        this.documentTags = tag;
    }

    void ResetTags()
    {

        tag = new List<string>();
        //documentTags = new List<string>();
        addTag1 = "";
        addTag2 = "";
        addTag3 = "";
        addTag4 = "";

    }

    void InitPageID()
    {
        if (state == "create")
        {
            tmpPageID = -1;
        }
        else if (state == "update")
        {
            tmpPageID = this.singlePage.ID;
        }

    }

    void SetTagList(List<string> tag)
    {
        this.tag = tag;
    }

    void SetTag1(string tag)
    {
        addTag1 = tag;

    }

    void SetTag2(string tag)
    {
        addTag2 = tag;

    }

    void SetTag3(string tag)
    {
        addTag3 = tag;

    }

    void SetTag4(string tag)
    {
        addTag4 = tag;

    }

    void SetUploadComponent(RadzenUpload uploadLocal)
    {
        this.uploadLocal = uploadLocal;
    }

    void SetUploadCompleted(bool uploadCompleted)
    {
        this.uploadCompleted = uploadCompleted;
        SetState__ParentEvent.InvokeAsync("records");
        string urlLocation = "/singlePages/" + singlePage.SubdepartmentID;
        navigationManager.NavigateTo(urlLocation, forceLoad: true);
    }
    void InitForm(SinglePage singlePage)
    {
        if (singlePage == null)
        {
            singlePage = new SinglePage();
        }
        else
        {
            this.singlePage = singlePage;
        }

    }

    void Submit(SinglePage singlePage)
    {
        this.singlePage = singlePage;
        int id = 0;
        //uploadLocal!.Upload();

        //if (tag.Count > 0)
        //{
        //documentsHandler!.setTagsList(tag);
        if (state == "create")
        {

            this.singlePage.SubdepartmentID = subdepartmentID;
            Create(singlePage);
            SinglePage lastInserted = dbContext.SinglePage.OrderByDescending(s => s.ID).FirstOrDefault();
            id = lastInserted.ID;
            tmpPageID = id;
            ShowAlert__ParentEvent.InvokeAsync(true);
            SetAlertMessage__ParentEvent.InvokeAsync("Record Succesfully created");
            SetAlertType__ParentEvent.InvokeAsync("alert alert-primary");
            //SetState__ParentEvent.InvokeAsync("update");
            //SetSinglePage__parentEvent.InvokeAsync(lastInserted);




        }
        else
        {

            Update(singlePage);
            id = singlePage.ID;
            ShowAlert__ParentEvent.InvokeAsync(true);
            SetAlertMessage__ParentEvent.InvokeAsync("Record Succesfully updated");
            SetAlertType__ParentEvent.InvokeAsync("alert alert-primary");

        }


        uploadLocal!.Upload();
        StoreAdditionalTags();
        singlePagesHelper.storeTags(id, parent, tag, "ContentTags.json");
        ReloadPage__ParentEvent.InvokeAsync();
        ResetTags();
        InitTagList();

        //}

    }

    void Create(SinglePage singlePage)
    {


        this.singlePage = singlePage;
        this.singlePage.AuthorName = userName;
        this.singlePage.DateTime = DateTime.Now;
        this.singlePage.Name = singlePage.Name;
        this.singlePage.PageContent = singlePage.PageContent;
        this.singlePage.SubdepartmentID = subdepartmentID;
        dbContext.SinglePage.Add(singlePage);
        dbContext.SaveChanges();
        this.state = "update";
        //SetState__ParentEvent.InvokeAsync("update");
        //SetSinglePage__parentEvent.InvokeAsync(lastInserted);


    }

    void ReloadDocumentsTable()
    {
        documents = documentsHandler.initDocuments(documents, parent, tmpPageID);

    }

    void ReloadPendingDocumentsTable()
    {
        pendingDocuments = documentsHandler!.initPendingDocuments(pendingDocuments!, parent, tmpPageID);

    }



    void StoreAdditionalTags()
    {
        if (addTag1 != "")
        {
            tag.Add(addTag1!);
        }

        if (addTag2 != "")
        {
            tag.Add(addTag2!);
        }

        if (addTag3 != "")
        {
            tag.Add(addTag3!);
        }

        if (addTag4 != "")
        {
            tag.Add(addTag4!);
        }



    }


    void Update(SinglePage singlePage)
    {
        singlePage.ModifiedBy = userName;
        singlePage.ModifiedDate = DateTime.Now;
        singlePage.PageContent = singlePage.PageContent;
        SinglePage prevSinglePage = dbContext.SinglePage.First(p => p.ID == singlePage.ID);
        prevSinglePage.PageContent = singlePage.PageContent;
        dbContext.Entry(prevSinglePage).CurrentValues.SetValues(singlePage);
        dbContext.SaveChanges();

    }

    void Cancel()
    {
        if (subdepartmentID == 0)
        {
            NavigationManager.NavigateTo("/itdocs");

        }
        else
        {
            singlePage = new SinglePage();
            documentsHandler.deleteDocuments__files(tmpDocuments, documentsHandler.getTmpDirectoryURL() + parent + "/");
            SetState__ParentEvent.InvokeAsync("records");
        }
    }
}